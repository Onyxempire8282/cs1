<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Data Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 5px; }
        .stats { display: flex; gap: 20px; flex-wrap: wrap; }
        .stat { padding: 10px; background: #f5f5f5; border-radius: 3px; min-width: 120px; }
        .user-info { background: #e3f2fd; padding: 10px; border-radius: 3px; }
        button { margin: 5px; padding: 8px 15px; border: none; border-radius: 3px; cursor: pointer; }
        .demo-btn { background: #ffeb3b; }
        .auth-btn { background: #4caf50; color: white; }
        .master-btn { background: #f44336; color: white; }
        .clear-btn { background: #9e9e9e; color: white; }
    </style>
</head>
<body>
    <h1>Dashboard Data Display Test</h1>
    
    <div class="test-section">
        <h2>User Type Controls</h2>
        <button class="demo-btn" onclick="setUserType('demo')">Set Demo User</button>
        <button class="auth-btn" onclick="setUserType('authenticated')">Set Authenticated User</button>
        <button class="master-btn" onclick="setUserType('master')">Set Master User</button>
        <button class="clear-btn" onclick="clearAuth()">Clear Authentication</button>
    </div>

    <div class="test-section">
        <h2>Current User Context</h2>
        <div class="user-info" id="user-info">
            Loading...
        </div>
    </div>

    <div class="test-section">
        <h2>Dashboard Stats</h2>
        <div class="stats" id="stats">
            <div class="stat">
                <div>Miles This Month</div>
                <div id="miles-stat">Loading...</div>
            </div>
            <div class="stat">
                <div>Routes Optimized</div>
                <div id="routes-stat">Loading...</div>
            </div>
            <div class="stat">
                <div>Jobs Completed</div>
                <div id="jobs-stat">Loading...</div>
            </div>
            <div class="stat">
                <div>Total Earnings</div>
                <div id="earnings-stat">Loading...</div>
            </div>
        </div>
    </div>

    <div class="test-section">
        <h2>Data Source</h2>
        <div id="data-source">Loading...</div>
    </div>

    <script type="module">
        import dashboardModule from './scripts/pages/dashboard.js';

        let dashboardInstance = null;

        // Initialize dashboard
        async function initDashboard() {
            try {
                dashboardInstance = dashboardModule.init();
                updateDisplay();
            } catch (error) {
                console.error('Dashboard initialization error:', error);
                document.getElementById('data-source').innerHTML = `<div style="color: red;">Error: ${error.message}</div>`;
            }
        }

        // Set user type for testing
        window.setUserType = function(userType) {
            const auth = {
                email: 'test@example.com',
                username: 'Test User',
                timestamp: Date.now()
            };

            if (userType === 'demo') {
                auth.demoMode = true;
                auth.demoExpiry = Date.now() + (7 * 24 * 60 * 60 * 1000); // 7 days
            } else if (userType === 'master') {
                auth.masterLogin = true;
                auth.email = 'inspects@flav8r.net';
                auth.username = 'Master Admin';
            } else {
                auth.demoMode = false;
                auth.masterLogin = false;
            }

            localStorage.setItem('claimcipher_auth', JSON.stringify(auth));
            
            // Reinitialize dashboard with new user type
            setTimeout(() => {
                initDashboard();
            }, 100);
        };

        // Clear authentication
        window.clearAuth = function() {
            localStorage.removeItem('claimcipher_auth');
            setTimeout(() => {
                initDashboard();
            }, 100);
        };

        // Update display
        function updateDisplay() {
            const auth = JSON.parse(localStorage.getItem('claimcipher_auth') || '{}');
            let userType = 'unauthenticated';
            
            if (auth.demoMode) userType = 'demo';
            else if (auth.masterLogin) userType = 'master';
            else if (auth.email) userType = 'authenticated';

            document.getElementById('user-info').innerHTML = `
                <div><strong>User Type:</strong> ${userType}</div>
                <div><strong>Email:</strong> ${auth.email || 'Not set'}</div>
                <div><strong>Username:</strong> ${auth.username || 'Not set'}</div>
                <div><strong>Demo Mode:</strong> ${auth.demoMode ? 'Yes' : 'No'}</div>
                <div><strong>Master Login:</strong> ${auth.masterLogin ? 'Yes' : 'No'}</div>
            `;

            document.getElementById('data-source').innerHTML = `
                <div><strong>Expected Data Source:</strong> ${userType === 'demo' ? 'Sample/Demo Data' : 'User-specific Data'}</div>
                <div><strong>Stats Should Show:</strong> ${userType === 'demo' ? 'Dynamic sample values' : 'Zero or user data'}</div>
            `;

            // Check if stats are being updated
            setTimeout(() => {
                const miles = document.getElementById('miles-stat').textContent;
                const routes = document.getElementById('routes-stat').textContent;
                const jobs = document.getElementById('jobs-stat').textContent;
                const earnings = document.getElementById('earnings-stat').textContent;

                console.log('Current stats:', { miles, routes, jobs, earnings });
                
                if (miles === 'Loading...' || routes === 'Loading...' || jobs === 'Loading...' || earnings === 'Loading...') {
                    document.getElementById('data-source').innerHTML += '<div style="color: orange;">⚠️ Stats not updated - check console for errors</div>';
                }
            }, 2000);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', initDashboard);
    </script>
</body>
</html>
